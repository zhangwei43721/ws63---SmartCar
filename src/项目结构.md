# WS63 项目结构分析

## 项目概述

这是一个基于 **HiSpark WS63 平台**的嵌入式项目，使用了 **Huawei LiteOS** 操作系统。项目采用 CMake 构建系统，支持多种编译选项和调试配置。

- **许可证**: Apache 2.0
- **开发平台**: HiSpark WS63
- **操作系统**: Huawei LiteOS
- **构建工具**: CMake, Python (build.py)

---

## 目录结构

```
.vscode/          # VSCode IDE 配置
analyzerJson/     # 代码分析和质量控制配置
application/      # 应用层代码
bootloader/       # 引导加载程序
build/            # CMake 构建系统配置
drivers/          # 设备驱动程序
include/          # 公共头文件
interim_binary/   # 编译中间二进制文件
kernel/           # 内核 (LiteOS)
libs_url/         # 第三方库 URL 配置
middleware/       # 中间件服务
open_source/      # 开源组件
output/           # 编译输出目录
protocol/         # 通信协议栈
tools/            # 开发工具
```

---

## 核心模块详解

### 1. application/ - 应用层
应用代码的顶层目录，包含具体业务逻辑实现。
- `samples/` - 示例代码
- `ws63/` - WS63 平台特定应用代码
- 配置文件: `CMakeLists.txt`, `Kconfig`

#### samples/peripheral/ - 外设示例模块

**基础外设模块**
| 模块名称 | 功能描述 | 文件结构 |
|---------|---------|---------|
| **adc** | ADC模数转换 | CMakeLists.txt, Kconfig, 示例代码 |
| **beep** | 蜂鸣器控制 | CMakeLists.txt, 示例代码, BSP层 |
| **button** | 按键控制 | CMakeLists.txt, 示例代码 |
| **dc_motor** | 直流电机控制 | CMakeLists.txt, 示例代码 |
| **dht11** | DHT11温湿度传感器 | CMakeLists.txt, 示例代码 |
| **ds18b20** | DS18B20温度传感器 | CMakeLists.txt, 示例代码 |
| **exti** | 外部中断 | CMakeLists.txt, 示例代码 |
| **fan** | 风扇控制 | CMakeLists.txt, 示例代码 |
| **gesture_sensor** | 手势传感器 | CMakeLists.txt, 示例代码 |
| **GH719** | GH719微波感应模块 | CMakeLists.txt, 示例代码 |
| **HC_SR501_BODY** | 人体红外感应 | CMakeLists.txt, 示例代码 |
| **hr_spo2** | 心率血氧传感器 | CMakeLists.txt, 示例代码 |
| **led** | LED控制 | CMakeLists.txt, 示例代码 |
| **pwm** | PWM脉宽调制 | CMakeLists.txt, Kconfig, 示例代码 |
| **pwm_led** | PWM控制LED呼吸灯 | CMakeLists.txt, 示例代码 |
| **soil_sensor** | 土壤湿度传感器 | CMakeLists.txt, 示例代码 |
| **step_motor** | 步进电机控制 | CMakeLists.txt, 示例代码 |

**通信接口模块**
| 模块名称 | 功能描述 | 文件结构 |
|---------|---------|---------|
| **i2c** | I2C主从机通信 | CMakeLists.txt, Kconfig, 示例代码 |
| **i2s_dma_lli** | I2S DMA LLI通信 | CMakeLists.txt, Kconfig, 示例代码 |
| **spi** | SPI主从机通信 | CMakeLists.txt, Kconfig, 示例代码 |
| **uart** | UART串口通信 | CMakeLists.txt, Kconfig, 示例代码 |
| **uartDemo** | UART演示程序 | CMakeLists.txt, 示例代码 |

**系统功能模块**
| 模块名称 | 功能描述 | 文件结构 |
|---------|---------|---------|
| **dma** | DMA直接内存访问 | CMakeLists.txt, Kconfig, 示例代码 |
| **event** | 事件管理 | CMakeLists.txt, 示例代码 |
| **pinctrl** | 引脚控制 | CMakeLists.txt, Kconfig, 示例代码 |
| **systick** | 系统滴答定时器 | CMakeLists.txt, 示例代码 |
| **timer** | 通用定时器 | CMakeLists.txt, Kconfig, 示例代码 |
| **watchdog** | 看门狗定时器 | CMakeLists.txt, Kconfig, 示例代码 |
| **tcxo** | 温补晶振 | CMakeLists.txt, 示例代码 |

**操作系统功能模块**
| 模块名称 | 功能描述 | 文件结构 |
|---------|---------|---------|
| **message** | 消息队列通信 | CMakeLists.txt, 示例代码 |
| **mutex** | 互斥锁同步 | CMakeLists.txt, 示例代码 |
| **semaphore** | 信号量同步 | CMakeLists.txt, Kconfig, 子目录 |
| ├── binary_semaphore/ | 二值信号量 | CMakeLists.txt, 示例代码 |
| └── count_semaphore/ | 计数信号量 | CMakeLists.txt, 示例代码 |
| **thread** | 线程管理 | CMakeLists.txt, Kconfig, 示例代码 |
| **tasks** | 任务管理 | CMakeLists.txt, 示例代码 |

**智能应用模块**
| 模块名称 | 功能描述 |
|---------|---------|
| **Smart_agriculture** | 智慧农业 |
| **Smart_gesture** | 智能手势控制 |
| **Smart_healthcare** | 智慧医疗 |
| **Smart_home** | 智能家居 |

**网络功能模块**
| 模块名称 | 功能描述 |
|---------|---------|
| **tcp_client** | TCP客户端 |
| **udp_client** | UDP客户端 |
| **wifi_mqtt** | WiFi MQTT通信 |
| **wifiap** | WiFi AP模式 |
| **wifista** | WiFi STA模式 |

### 2. bootloader/ - 引导加载程序
系统启动时首先运行的代码，负责初始化硬件和加载主程序。
- `commonboot/` - 通用引导代码
- `flashboot_ws63/` - WS63 平台闪存引导
- `provision_ws63/` - WS63 平台配置代码

### 3. kernel/ - 内核层
提供操作系统核心功能和硬件抽象。
- `liteos/` - Huawei LiteOS 操作系统内核
- `non_os/` - 无操作系统支持（裸机模式）
- `osal/` - 操作系统抽象层
- `osal_adapt/` - OS 适配层

功能: 任务调度、内存管理、进程间通信等

### 4. drivers/ - 设备驱动程序
硬件驱动和板级支持包。
- `adapter/` - 驱动适配层
- `boards/` - 板级支持包 (BSP)
- `chips/` - 芯片相关驱动
- `drivers/` - 具体驱动实现

### 5. protocol/ - 通信协议栈
各种通信协议的实现。
- `bt/` - 蓝牙协议栈
- `wifi/` - Wi-Fi 协议栈
- `radar/` - 雷达相关协议

### 6. middleware/ - 中间件
介于操作系统和应用之间的服务组件。
- `chips/` - 芯片相关中间件
- `services/` - 各种服务组件
- `utils/` - 工具库和通用函数

---

## 配置与工具

### build/ - 构建系统
CMake 构建配置，包含编译规则和菜单配置。

### include/ - 公共头文件
- `driver/` - 驱动头文件
- `middleware/` - 中间件头文件
- `common_def.h` - 通用定义
- `errcode.h` - 错误码定义
- `cfbb_version.h` - 版本信息

### tools/ - 开发工具
- `bin/` - 可执行工具
- `pkg/` - 工具包

---

## 临时文件与输出

| 目录 | 用途 |
|------|------|
| `output/` | 编译生成的二进制文件、可执行文件 |
| `interim_binary/` | 编译过程中的中间文件 |

---

## 构建系统

### 构建入口: build.py

```bash
# 基本编译
python build.py

# 清理后编译
python build.py -c

# 多线程编译
python build.py -j 8

# 定义宏
python build.py -def MACRO_NAME=value

# 指定编译组件
python build.py -component component_name

# 使用 ninja 构建
python build.py -ninja
```

### 项目配置文件
- `CMakeLists.txt` - CMake 主配置文件
- `fbb_ws63.hiproj` - HiSpark Studio 项目配置
- `config.in` - Kconfig 配置入口
- `LICENSE` - Apache 2.0 许可证

---

## 项目架构

```
┌─────────────────────────────────────┐
│         Application Layer           │
│         (application/)              │
└─────────────────────────────────────┘
                  ↓
┌─────────────────────────────────────┐
│      Middleware & Protocol          │
│   (middleware/, protocol/)          │
└─────────────────────────────────────┘
                  ↓
┌─────────────────────────────────────┐
│           Kernel & OSAL             │
│          (kernel/)                  │
└─────────────────────────────────────┘
                  ↓
┌─────────────────────────────────────┐
│         Drivers (HAL)               │
│         (drivers/)                  │
└─────────────────────────────────────┘
```

---

## 适用场景

本项目架构适用于：
- 物联网设备开发
- 嵌入式系统开发
- 支持蓝牙、Wi-Fi、雷达等通信功能的智能设备

---

## 添加新外设模块的完整流程

### 步骤 1: 创建模块目录结构

在 `application/samples/peripheral/` 下创建新模块目录：

```
application/samples/peripheral/new_module/
├── CMakeLists.txt          # 必需：CMake 构建配置
├── Kconfig                 # 可选：Kconfig 配置（如果需要配置选项）
├── new_module_example.c    # 必需：示例代码
├── bsp_include/            # 可选：BSP 头文件（复杂模块需要）
│   └── bsp_new_module.h
└── bsp_src/                # 可选：BSP 源文件（复杂模块需要）
    └── bsp_new_module.c
```

### 步骤 2: 创建 CMakeLists.txt

**简单模块示例**（如 button 模块）：
```bash
set(SOURCES "${SOURCES}" "${CMAKE_CURRENT_SOURCE_DIR}/new_module_example.c" PARENT_SCOPE)
```

**复杂模块示例**（如 beep 模块，带 BSP 层）：
```bash
# 添加头文件路径
set(HEADER_LIST ${CMAKE_CURRENT_SOURCE_DIR}/bsp_include)

# 添加源文件
set(SOURCES_LIST
    ${CMAKE_CURRENT_SOURCE_DIR}/bsp_src/bsp_new_module.c
    ${CMAKE_CURRENT_SOURCE_DIR}/new_module_example.c
)

# 设置到父作用域
set(SOURCES "${SOURCES}" "${SOURCES_LIST}" PARENT_SCOPE)
set(PUBLIC_HEADER "${PUBLIC_HEADER}" ${HEADER_LIST} PARENT_SCOPE)
```

**子模块示例**（如 semaphore 模块，包含子目录）：
```bash
# 根据配置选择编译哪个子模块
if(DEFINED CONFIG_SAMPLE_SUPPORT_BINARY_SEMAPHORE)
    add_subdirectory_if_exist(binary_semaphore)
endif()

if(DEFINED CONFIG_SAMPLE_SUPPORT_COUNT_SEMAPHORE)
    add_subdirectory_if_exist(count_semaphore)
endif()

set(SOURCES "${SOURCES}" PARENT_SCOPE)
```

### 步骤 3: 创建 Kconfig（可选）

**基本配置**：
```bash
config SAMPLE_SUPPORT_NEW_MODULE
    bool
    prompt "Support New Module Sample."
    default n
    depends on ENABLE_PERIPHERAL_SAMPLE
    help
        This option means support New Module Sample.

if SAMPLE_SUPPORT_NEW_MODULE
menu "New Module Sample Configuration"
    # 模块特定的配置选项
    config NEW_MODULE_PARAM
        int "New module parameter"
        default 100
        help
            This is a parameter for new module.
endmenu
endif
```

**带子选择的配置**（如 semaphore）：
```bash
choice
    prompt "Select module type"
    default SAMPLE_SUPPORT_NEW_MODULE_TYPE_A
    config SAMPLE_SUPPORT_NEW_MODULE_TYPE_A
        bool "Enable Type A."
    config SAMPLE_SUPPORT_NEW_MODULE_TYPE_B
        bool "Enable Type B."
endchoice
```

### 步骤 4: 创建示例代码

**标准文件头格式**：
```c
/**
 ****************************************************************************************************
 * @file        new_module_example.c
 * @author      Your Name
 * @version     V1.0
 * @date        2025-01-09
 * @brief       LiteOS 新模块示例
 * @license     Copyright (c) 2024-2034
 ****************************************************************************************************
 * @attention
 *
 * 实验平台:Hi3863
 * 在线视频:
 * 公司网址:
 * 购买地址:
 *
 ****************************************************************************************************
 * 实验现象：描述实验功能
 *
 ****************************************************************************************************
 */

#include "pinctrl.h"
#include "common_def.h"
#include "soc_osal.h"
#include "gpio.h"
#include "app_init.h"

#define TASK_STACK_SIZE 0x1000
#define TASK_PRIORITY    24

static void *new_module_task(const char *arg)
{
    unused(arg);

    // 模块初始化
    printf("new module init\n");

    while (1) {
        // 实现模块功能
        osal_msleep(1000);
    }
    return NULL;
}

static void new_module_entry(void)
{
    osal_task *task_handle = NULL;

    osal_kthread_lock();
    task_handle = osal_kthread_create((osal_kthread_handler)new_module_task,
                                      NULL,
                                      "new_module_task",
                                      TASK_STACK_SIZE);
    if (task_handle != NULL) {
        osal_kthread_set_priority(task_handle, TASK_PRIORITY);
    }
    osal_kthread_unlock();
}

app_run(new_module_entry);
```

### 步骤 5: 在主 CMakeLists.txt 中注册

编辑 `application/samples/peripheral/CMakeLists.txt`，添加模块编译条件：

```bash
# 添加新模块子系统
if(DEFINED CONFIG_SAMPLE_SUPPORT_NEW_MODULE)
    add_subdirectory_if_exist(new_module)
endif()
```

**注意**：
- 条件宏必须是 `CONFIG_` 前缀 + Kconfig 中定义的配置项名
- 例如：Kconfig 中定义 `SAMPLE_SUPPORT_NEW_MODULE`，CMake 中检查 `CONFIG_SAMPLE_SUPPORT_NEW_MODULE`

### 步骤 6: 在主 Kconfig 中注册

编辑 `application/samples/peripheral/Kconfig`，添加两个位置：

**位置 1：在 `ENABLE_ALL_PERIPHERAL_SAMPLE` 中添加**
```bash
config ENABLE_ALL_PERIPHERAL_SAMPLE
    bool
    prompt "Enable all the sample of peripheral"
    default n
    depends on ENABLE_PERIPHERAL_SAMPLE
    select SAMPLE_SUPPORT_NEW_MODULE    # 添加这一行
    help
        This option means enable all the sample of peripheral.
```

**位置 2：添加独立配置项**
```bash
config SAMPLE_SUPPORT_NEW_MODULE
    bool
    prompt "Support New Module Sample."
    default n
    depends on ENABLE_PERIPHERAL_SAMPLE
    help
        This option means support New Module Sample.

if SAMPLE_SUPPORT_NEW_MODULE
menu "New Module Sample Configuration"
    osource "application/samples/peripheral/new_module/Kconfig"
endmenu
endif
```

### 步骤 7: 配置和编译

1. **运行 menuconfig** 启用模块：
   ```bash
   python build.py menuconfig
   ```
   导航到：`Application` → `Config the application` → `Enable the Sample of peripheral` → 启用 `Support New Module Sample.`

2. **编译项目**：
   ```bash
   python build.py
   ```

3. **配置文件位置**：
   - 配置保存在：`build/config/target_config/ws63/menuconfig/acore/ws63_liteos_app.config`
   - 手动添加配置：`CONFIG_SAMPLE_SUPPORT_NEW_MODULE=y`

### 注意事项

1. **命名规范**：
   - 模块目录名：小写，下划线分隔（如 `pwm_led`）
   - 配置宏：大写，下划线分隔（如 `CONFIG_SAMPLE_SUPPORT_PWM_LED`）
   - 示例文件：`{module}_example.c`（如 `pwm_led_example.c`）

2. **避免重复定义**：
   - 检查 `CMakeLists.txt` 中是否已添加该模块
   - 检查 `Kconfig` 中配置项是否重复定义

3. **依赖关系**：
   - 如果模块依赖其他功能，在 Kconfig 中使用 `depends on`
   - 使用 `select` 自动启用依赖项

4. **引脚定义**：
   - 参考现有模块（如 `led`, `button`）的引脚定义
   - 确保引脚不冲突

5. **任务创建注意事项**：
   - 使用 `osal_kthread_lock()` 防止任务调度
   - 任务创建后设置优先级
   - 不要立即 `osal_kfree()` 任务句柄（这是常见错误）

---

*文档更新日期: 2026-01-09*
