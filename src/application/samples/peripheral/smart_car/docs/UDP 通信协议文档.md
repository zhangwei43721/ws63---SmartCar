# 智能小车 UDP 通信接口文档

## 1. 基础配置

- **通信方式**：UDP（无连接协议，需代码逻辑实现可靠性）
- **端口映射**：
  - **手机发送端端口**：任意可用端口 → **小车接收端口**：`8888`
  - **手机接收端端口**：`8889`（监听小车上报/广播）
- **数据格式**：二进制 大端序

---

## 2. 数据包结构体定义

协议使用三种结构体格式：

### 2.1 通用控制/状态/心跳包（5 字节）

```c
typedef struct __attribute__((packed)) {
    uint8_t type;     // 数据包类型
    uint8_t cmd;      // 命令/模式编号
    int8_t  data1;    // 左轮速度或参数高字节
    int8_t  data2;    // 右轮速度或参数低字节
    uint8_t ext;      // 扩展字段/保留
} udp_packet_t;
```

**适用包类型**：

- 0x01 运动控制
- 0x02 状态回传
- 0x03 模式切换
- 0x04 PID 参数配置
- 0xFE 心跳保活

### 2.2 设备发现包（23 字节）

```c
typedef struct __attribute__((packed)) {
    uint8_t type;    // 0xFF
    uint8_t mac[6];  // MAC 地址
    char    name[16]; // 设备名称（C 字符串，\0 结尾）
} discovery_packet_t;
```

### 2.3 WiFi 配置包（变长，最多 99 字节）

```c
typedef struct __attribute__((packed)) {
    uint8_t type;      // 0xE0/0xE1/0xE2
    uint8_t ssid_len;  // SSID 长度
    char    ssid[32];  // WiFi 名称
    uint8_t pass_len;  // 密码长度
    char    password[64]; // WiFi 密码
} wifi_config_packet_t;
```

---

## 3. 第一阶段：扫描发现

小车未建立连接时，会向局域网广播地址（如 `255.255.255.255`）每 500ms 发送一次发现包。

### 3.1 设备发现包 (小车 → 手机, Type = 0xFF)

_手机端需开启 UDP Socket 监听 `8889` 端口。_

| 偏移 (Byte) | 字段   | 类型     | 说明                          |
| ----------- | ------ | -------- | ----------------------------- |
| 0           | `type` | uint8    | **0xFF** (识别标识)           |
| 1~6         | `mac`  | byte[6]  | 小车唯一 MAC 地址             |
| 7~22        | `name` | char[16] | 小车名称字符串 (以 `\0` 结尾) |

---

## 4. 第二阶段：连接握手

**核心逻辑**：选定小车 IP 后，手机必须定期向小车发送任意指令包（运动控制/模式切换/PID配置/心跳等）。小车收到第一个有效包后，将停止广播，并锁定手机 IP 进入"连接状态"。

> **注意**：只要发送任何有效指令包即可维持连接。如果 5 秒内未收到任何包，小车会自动断开并回到广播模式。

### 4.0 握手/心跳接口 (手机 → 小车, Type = 0xFE)

_发送至小车 IP:8888。这是最简单的保活方式。_

| 偏移 (Byte) | 字段   | 类型  | 赋值          |
| ----------- | ------ | ----- | ------------- |
| 0           | `type` | uint8 | **0xFE**      |
| 1~4         | `data` | -     | 全部填 `0x00` |

---

## 5. 第三阶段：交互控制

只有在"连接状态"下，以下接口才生效。

### 5.1 模式切换 (手机 → 小车, Type=0x03)

| 偏移 (Byte) | 字段   | 类型  | 说明                               |
| ----------- | ------ | ----- | ---------------------------------- |
| 0           | `type` | uint8 | **0x03**                           |
| 1           | `cmd`  | uint8 | **0:待机, 1:循迹, 2:避障, 3:遥控** |
| 2~4         | `data` | -     | 填 `0x00`                          |

### 5.2 运动控制 (手机 → 小车, Type=0x01)

**仅当小车处于遥控模式（cmd=3）时生效！**

| 偏移 (Byte) | 字段    | 类型  | 说明                      |
| ----------- | ------- | ----- | ------------------------- |
| 0           | `type`  | uint8 | **0x01**                  |
| 1           | `cmd`   | uint8 | 保留 (0x00)               |
| 2           | `data1` | int8  | **左轮速度** (-100 ~ 100) |
| 3           | `data2` | int8  | **右轮速度** (-100 ~ 100) |
| 4           | `ext`   | uint8 | 保留 (0x00)               |

### 5.3 状态回传与心跳 (小车 → 手机, Type=0x02 / 0xFE)

连接成功后，小车每 2s 向手机发送一次数据包。手机监听 `8889` 接收。

**智能发送机制**：

- **状态有变化** → 发送 `0x02` 状态包（包含完整传感器数据）
- **状态无变化** → 发送 `0xFE` 纯心跳包（仅保活，无数据）

**0x02 状态包结构**（状态变化时发送）：

| 偏移 (Byte) | 字段    | 类型  | 说明                                                         |
| ----------- | ------- | ----- | ------------------------------------------------------------ |
| 0           | `type`  | uint8 | **0x02**                                                     |
| 1           | `cmd`   | uint8 | 当前运行模式 (0-3)                                           |
| 2           | `data1` | int8  | **超声波距离** (单位: cm \* 10)                              |
| 3           | `data2` | -     | 保留                                                         |
| 4           | `ext`   | uint8 | **三路巡线传感器状态**: Bit0:左, Bit1:中, Bit2:右 (1 为触发) |

**0xFE 心跳包结构**（状态无变化时发送）：

| 偏移 (Byte) | 字段   | 说明        |
| ----------- | ------ | ----------- |
| 0           | `type` | **0xFE**    |
| 1~4         | `data` | 全部 `0x00` |

### 5.4 PID 参数配置 (手机 → 小车, Type=0x04)

用于实时调整循迹/避障模式的 PID 参数。

| 偏移 (Byte) | 字段    | 类型  | 说明                                       |
| ----------- | ------- | ----- | ------------------------------------------ |
| 0           | `type`  | uint8 | **0x04**                                   |
| 1           | `cmd`   | uint8 | **参数类型**: 1=Kp, 2=Ki, 3=Kd, 4=目标速度 |
| 2           | `data1` | uint8 | 参数值高 8 位                              |
| 3           | `data2` | uint8 | 参数值低 8 位                              |
| 4           | `ext`   | -     | 保留 (0x00)                                |

**参数取值范围与换算**：
| cmd | 参数名 | data1,data2 组合值 | 实际值 | 范围 |
| --- | --- | --- | --- | --- |
| 1 | Kp | value × 256 | value × 0.01 | 0.00 ~ 655.35 |
| 2 | Ki | value × 256 | value × 0.1 | 0.0 ~ 6553.5 |
| 3 | Kd | value × 256 | value × 0.1 | 0.0 ~ 6553.5 |
| 4 | Speed | value | value (整数) | 0 ~ 65535 |

**示例**：设置 Kp = 25.0

```
value = 25.0 / 0.01 = 2500
data1 = 2500 >> 8 = 9 (0x09)
data2 = 2500 & 0xFF = 196 (0xC4)
发送: 0x04 0x01 0x09 0xC4 0x00
```

---

## 6. WiFi 配置接口

在任何连接状态下（AP 模式或 STA 模式），均可通过以下命令配置并切换 WiFi。

### 6.1 保存 WiFi 配置 (手机 → 小车, Type=0xE0)

仅保存配置到存储，不立即连接。

| 偏移 (Byte) | 字段       | 类型     | 说明                |
| ----------- | ---------- | -------- | ------------------- |
| 0           | `type`     | uint8    | **0xE0**            |
| 1           | `ssid_len` | uint8    | SSID 长度 (最大 32) |
| 2~33        | `ssid`     | char[32] | WiFi 名称           |
| 34          | `pass_len` | uint8    | 密码长度 (最大 64)  |
| 35~98       | `password` | char[64] | WiFi 密码           |

### 6.2 保存并连接 (手机 → 小车, Type=0xE1)

保存配置并立即切换到 STA 模式尝试连接。

包格式同 `0xE0`。

### 6.3 查询 WiFi 配置 (手机 → 小车, Type=0xE2)

查询当前保存的 WiFi 配置。

| 偏移 (Byte) | 字段       | 赋值              |
| ----------- | ---------- | ----------------- |
| 0           | `type`     | **0xE2**          |
| 1           | `ssid_len` | 0x00 (请求时填 0) |

**响应包格式**（小车 → 手机）：

| 偏移 (Byte) | 字段       | 类型     | 说明      |
| ----------- | ---------- | -------- | --------- |
| 0           | `type`     | uint8    | **0xE2**  |
| 1           | `ssid_len` | uint8    | SSID 长度 |
| 2~33        | `ssid`     | char[32] | WiFi 名称 |
| 34          | `pass_len` | uint8    | 密码长度  |
| 35~98       | `password` | char[64] | WiFi 密码 |

---

## 7. WiFi 工作模式

| 模式         | 说明                                    |
| :----------- | :-------------------------------------- |
| **智能模式** | STA 优先，失败后自动切换 AP             |
| **STA 模式** | 固定连接到指定路由器                    |
| **AP 模式**  | 作为热点供设备连接 (SSID: `WS63_Robot`) |

**智能模式启动流程**：

```
启动 → 尝试从存储加载 WiFi 配置
        ↓
   连接 STA（3秒超时）
        ↓
成功?    失败
  ↓        ↓
STA    进入 AP 模式
模式
```

---

## 8. 开发流程梳理

### 1. 扫描与识别

- 手机开启接收线程，监听 `8889`。
- 解析到 `0xFF` 包，提取包信息获取小车 IP。
- 在 UI 界面展示小车列表。

### 2. 握手连接

- 用户点击"连接" → 开启定时器。
- **定时器任务**：每 1000ms 向小车 IP:8888 发送任意指令包（推荐用 `0xFE` 心跳包）。
- **状态反馈**：当手机开始收到小车发回的 `0x02` 状态包或 `0xFE` 心跳包时，说明握手成功。

### 3. 数据交互

- **发送**：
  - 根据按钮事件发送 `0x03` 包切换模式
  - **仅在遥控模式下**：根据 UI 摇杆事件发送 `0x01` 包
  - 任何发送操作都会自动维持连接（无需单独心跳）
- **接收**：
  - 解析 `0x02` 状态包，更新界面上的距离和红外灯状态
  - 收到 `0xFE` 心跳包表示连接正常但状态无变化

### 4. 断开连接

- 停止发送任何数据包。
- 小车在 5 秒内未收到任何包将自动断开

---

## 9. 附录：完整数据包类型汇总

| Type     | 方向      | 结构体 | 长度 | 功能说明                   |
| :------- | :-------- | :----- | :--- | :------------------------- |
| **0x01** | 手机→小车 | 通用包 | 5    | 运动控制（仅遥控模式生效） |
| **0x02** | 小车→手机 | 通用包 | 5    | 状态上报                   |
| **0x03** | 手机→小车 | 通用包 | 5    | 模式切换                   |
| **0x04** | 手机→小车 | 通用包 | 5    | PID 参数配置               |
| **0xFE** | 双向      | 通用包 | 5    | 心跳保活                   |
| **0xFF** | 小车→手机 | 发现包 | 23   | 设备发现广播               |
| **0xE0** | 手机→小车 | WiFi包 | 变长 | 保存 WiFi 配置             |
| **0xE1** | 手机→小车 | WiFi包 | 变长 | 保存并连接 WiFi            |
| **0xE2** | 双向      | WiFi包 | 变长 | 查询 WiFi 配置             |
