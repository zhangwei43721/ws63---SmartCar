# 鸿蒙 WS63 智能小车 (Smart Car K12 Edition)

## 概述

本模块基于海思 WS63 芯片，为 K12 教育及嵌入式教学提供了完整的智能小车控制框架。采用分层架构设计，将底层硬件驱动（Drivers）、功能服务层（Services）与上层业务逻辑（Apps）解耦，支持模块化开发与独立测试。

主要功能模块包括：

- **L9110S 电机驱动** - 基础运动控制（PWM 线性调速、差速控制）
- **HC-SR04 超声波传感器** - 测距与避障
- **TCRT5000 红外循迹传感器** - 黑线识别与循迹
- **SG90 舵机控制** - 角度控制与扫描
- **SSD1306 OLED 显示屏** - 状态显示 (I2C，支持中文)
- **WiFi UDP 通信** - WiFi 网络连接、遥控命令、OTA 升级
- **HTTP 控制服务** - Web 界面控制与参数配置
- **NV 存储服务** - 运行参数持久化存储

## 架构设计

### 1. 软件分层架构

为了实现代码的高复用性与清晰度，本项目采用三层逻辑架构：

```c
+------------------------------------------------------------------+
|                      应用业务层 (Apps)                            |
|  - 任务调度、状态机管理 (State Machine)                             |
|  - 人机交互 (OLED/按键)                                           |
|  - 核心入口：robot_demo.c                                         |
+------------------------------------------------------------------+
                       | 调用
+------------------------------------------------------------------+
|                      功能服务层 (Services)                        |
|  - UI Service (OLED 显示、中文字体)                                |
|  - UDP Service (遥控命令、状态上报、OTA)                            |
|  - HTTP Service (Web API)                                        |
|  - Storage Service (NV 参数持久化)                                 |
+------------------------------------------------------------------+
                       | 调用
+------------------------------------------------------------------+
|                      硬件驱动层 (Drivers)                         |
|  - 纯粹的硬件抽象层 (HAL)                                          |
|  - 标准接口：Init/Write/Read，无业务逻辑                            |
+------------------------------------------------------------------+
```

### 2. robot_demo 模块架构

`robot_demo` 是智能小车的核心应用，采用状态机模式管理多种运行模式：

```text
apps/robot_demo/
├── robot_demo.c           # 主入口：任务创建、按键中断处理
├── robot_common.h         # 公共定义：CarStatus 枚举、RobotState 结构体
│
├── core/                  # 【硬件管理层】
│   ├── robot_mgr.c/h      # 状态机管理器：模式切换、生命周期管理
│   ├── robot_config.h     # 配置常量：时间参数、网络配置、缓冲区大小
│   ├── mode_common.c/h    # 模式公共接口：遥测数据上报
│   ├── mode_trace.c/h     # 循迹模式：PID 控制算法
│   ├── mode_obstacle.c/h  # 避障模式：超声波测距与转向决策
│   └── mode_remote.c/h    # 遥控模式：UDP 命令解析与超时保护
│
└── services/              # 【软件服务层】
    ├── ui_service.c/h         # OLED 显示服务
    ├── udp_service.c/h        # UDP 通信服务
    ├── udp_net_common.c/h     # UDP 网络公共层
    ├── http_ctrl_service.c/h  # HTTP 控制服务（已弃用）
    ├── storage_service.c/h    # NV 存储服务
    ├── ota_service.c/h        # OTA 升级服务（未开发完成）
    └── net_service.c/h        # 网络服务（已弃用）
```

### 3. 模式接口设计

每个运行模式实现统一的 `RobotModeOps` 接口：

```c
typedef struct {
    void (*enter)(void);   // 模式进入时调用（初始化）
    void (*tick)(void);    // 周期性调用（主循环逻辑）
    void (*exit)(void);    // 模式退出时调用（清理）
} RobotModeOps;
```

| 模式 | 状态枚举 | 功能描述 |
|:---|:---|:---|
| **待机模式** | `CAR_STOP_STATUS` | 电机锁定，显示 WiFi 状态和 IP 地址 |
| **循迹模式** | `CAR_TRACE_STATUS` | PID 控制沿黑线行驶，支持实时参数调整 |
| **避障模式** | `CAR_OBSTACLE_AVOIDANCE_STATUS` | 超声波测距自动避障，阈值可配置 |
| **WiFi 遥控** | `CAR_WIFI_CONTROL_STATUS` | UDP 命令遥控，500ms 超时保护 |

### 4. 目录结构

```text
application/samples/peripheral/smart_car/
├── CMakeLists.txt          # 顶层构建脚本
├── Kconfig                 # 顶层配置菜单
├── README.md               # 本文件
│
├── drivers/                # 【硬件驱动层】
│   ├── l9110s/             # 电机驱动（支持差速控制）
│   ├── hcsr04/             # 超声波驱动
│   ├── tcrt5000/           # 红外循迹驱动
│   ├── sg90/               # 舵机驱动
│   └── ssd1306/            # OLED 驱动（支持中文）
│
└── apps/                   # 【应用业务层】
    ├── robot_demo/         # [核心] 智能小车综合应用
    │   ├── core/           # 核心管理层
    │   └── services/       # 功能服务层
    │
    ├── test_l9110s/        # 单元测试：电机
    ├── test_hcsr04/        # 单元测试：超声波
    ├── test_sg90/          # 单元测试：舵机
    ├── test_tcrt5000/      # 单元测试：红外循迹
    └── test_ssd1306/       # 单元测试：OLED显示
```

## 硬件连接

> **重要提示**: 以下引脚定义基于当前代码配置，请严格按照此接线。

| 模块 | 功能 | GPIO引脚 | 备注 |
|:---|:---|:---|:---|
| **L9110S 电机** | 左轮 A/B | GPIO 6 / 7 | PWM 控制 |
| | 右轮 A/B | GPIO 8 / 9 | PWM 控制 |
| **HC-SR04** | TRIG / ECHO | GPIO 11 / 12 | 超声波测距 |
| **TCRT5000** | 左 / 中 / 右 | GPIO 4 / 2 / 0 | 循迹传感器 |
| **SG90 舵机** | PWM 信号 | GPIO 13 | 头部舵机 |
| **SSD1306** | SCL / SDA | GPIO 15 / 16 | I2C OLED 显示屏 |
| **按键** | 模式切换 | GPIO 3 | KEY1 (低电平触发) |

## 运行模式与功能说明

本模块采用 **"单应用模式"**，请在 `menuconfig` 的 `Select Running Application` 中选择对应的任务。

### 1. 综合应用 (Robot Demo)

**功能**：集成循迹、避障、WiFi 遥控的完整业务逻辑。

**操作**：单击 KEY1 按键循环切换以下 4 种模式。

#### 模式切换顺序

```
┌─────────────────────────────────────────────────────────────┐
│                    按键切换循环                              │
├─────────────────────────────────────────────────────────────┤
│   停止 ──► 循迹 ──► 避障 ──► WiFi遥控 ──► 停止             │
│  (Standby)  (Trace)  (Avoid)    (Remote)                    │
└─────────────────────────────────────────────────────────────┘
```

#### 模式详细说明

**1. 待机模式 (Standby)**
- **行为**：电机锁定
- **显示**：OLED 显示 WiFi 连接状态和本机 IP 地址
- **用途**：系统启动默认模式，等待用户切换

**2. 循迹模式 (Tracking)**
- **行为**：根据底部 3 路红外传感器状态，自动沿黑线行驶
- **算法**：PID 控制算法，支持实时参数调整
- **遥测**：定期上报红外状态和 PID 调试数据
- **特点**：
  - 动态速度调整（误差大时自动减速）
  - 积分分离（防止过冲）
  - 丢失黑线记忆功能

**3. 避障模式 (Avoid)**
- **行为**：自动前进，当距离 < 阈值时停车并扫描
- **阈值**：可通过 Web 界面配置（默认 20cm）
- **策略**：停车 → 后退 → 左右扫描 → 选择宽敞方向 → 转向前进
- **遥测**：定期上报超声波距离数据

**4. WiFi 遥控模式 (Remote)**
- **行为**：响应上位机 UDP 指令
- **保护**：500ms 超时自动急停，舵机回中
- **支持**：差速控制、舵机转向

### 2. UDP 遥控协议

上位机通过 WiFi 发送 4 字节 Hex 数据流（建议 25ms/帧）：

| 字节 | 类型 | 含义 | 说明 |
|:---|:---|:---|:---|
| **Byte 0** | `int8_t` | **左电机** | `0`:停, `[1,100]`:前, `[-100,-1]`:后 |
| **Byte 1** | `int8_t` | **右电机** | `0`:停, `[1,100]`:前, `[-100,-1]`:后 |
| **Byte 2** | `int8_t` | **舵机** | `0`:中, `[1,180]`:角度 |
| **Byte 3** | `int8_t` | **校验** | `Byte[0] ^ Byte[1] ^ Byte[2]` |

**UDP 服务器配置**：
- 端口：`8888`
- 广播端口：`8889`（用于设备发现）

### 3. 单元测试 (Unit Tests)

为确保硬件正常，提供了独立的测试工程供开发者逐一验证：

| 测试模块 | 功能描述 | 验证方法 |
|:---|:---|:---|
| **test_l9110s** | 电机测试 | 观察"前进→后退→左转→右转→停止"循环 |
| **test_hcsr04** | 超声波测试 | 串口查看距离日志 `Distance: xx cm` |
| **test_tcrt5000** | 红外循迹测试 | 遮挡传感器观察电平变化 |
| **test_sg90** | 舵机测试 | 观察 0°~180° 往复扫描 |
| **test_ssd1306** | OLED 测试 | 显示测试图案、中文、数字 |

## 配置参数说明

### 可配置参数（通过 NV 存储）

| 参数 | 默认值 | 说明 |
|:---|:---|:---|
| `obstacle_threshold_cm` | 20 | 避障距离阈值（cm） |
| `servo_center_angle` | 90 | 舵机回中角度（0~180） |

### 循迹 PID 参数

| 参数 | 默认值 | 说明 |
|:---|:---|:---|
| `Kp` | 16.0 | 比例系数 |
| `Ki` | 0.0 | 积分系数 |
| `Kd` | 0.0 | 微分系数 |
| `base_speed` | 40 | 基础速度 |

> 注：PID 参数可通过 Web 界面实时调整，无需重启设备。

## 开发者指南

### 如何编译与烧录

1. **进入配置菜单**
   
   ```bash
   python build.py menuconfig
   ```
   
2. **选择应用**
   导航至 `Application` -> `Support Smart Car Sample` -> `Select Running Application`
   
   - 选择 `Robot Demo` 运行综合应用
   - 或选择具体 `Test: ...` 模块进行硬件测试
   
3. **编译并烧录**
   保存配置并退出，脚本自动开始编译。编译完成后使用烧录工具烧录。

### 如何添加新硬件模式

1. **创建模式文件**
   在 `apps/robot_demo/core/` 下创建 `mode_xxx.c` 和 `mode_xxx.h`

2. **实现模式接口**
   ```c
   void mode_xxx_enter(void) { /* 初始化逻辑 */ }
   void mode_xxx_tick(void)  { /* 周期执行逻辑 */ }
   void mode_xxx_exit(void)  { /* 清理逻辑 */ }
   ```

3. **注册到状态机**
   在 `robot_mgr.c` 的 `g_mode_ops` 数组中添加：
   
   ```c
   {mode_xxx_enter, mode_xxx_tick, mode_xxx_exit}
   ```
   
4. **添加状态枚举**
   在 `robot_common.h` 的 `CarStatus` 枚举中添加新状态

### 如何添加新软件服务

1. **创建服务文件**
   在 `apps/robot_demo/services/` 下创建服务头文件和源文件

2. **实现服务接口**
   提供 `xxx_service_init()` 和必要的业务接口

3. **在 robot_mgr 中初始化**
   在 `robot_mgr_init()` 中调用服务的初始化函数

## 更新记录

| 日期 | 更新内容 |
|:---|:---|
| **2025-01-18** | 重构 robot_demo 架构，分离 core 和 services；添加 PID 循迹算法；添加 NV 存储服务 |
| **2025-01-14** | 升级通信协议为 4字节 HEX 格式，支持差速控制 |
| **2025-01-12** | 初始版本，预留基础循迹、避障、遥控功能框架 |
