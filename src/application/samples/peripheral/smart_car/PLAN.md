# 鸿蒙WS63智能小车研发任务书

## 1. 项目概述
本项目旨在基于海思 WS63 芯片，开发一款具备远程控制与自动驾驶基础功能的智能小车（K12教育版）。软件架构需采用模块化设计，支持鸿蒙系统（LiteOS），并实现手机端与设备端的局域网互联。

## 2. 功能需求规格

系统软件逻辑采用 **“状态机（State Machine）”** 架构，包含以下四种工作模式：

### 2.1 待机模式 (Standby Mode) - **[P0 优先级]**
*   **触发条件**：系统上电默认进入，或通过指令/按键停止其他模式。
*   **功能定义**：
    *   电机强制停转。
    *   OLED 显示屏显示本机 IP 地址、连接状态及 "Mode: Standby"。
    *   WiFi 保持连接，后台监听 TCP 端口（Server/Client均可，建议Client连接手机Server）。
    *   LED 呼吸灯闪烁（如有）。

### 2.2 远程遥控模式 (Remote Mode) - **[P0 优先级]**
*   **通信协议**：TCP Socket / UDP (推荐 UDP，但 TCP 亦可，视稳定性而定)
*   **数据频率**：25ms/帧 (40Hz)
*   **数据格式**：定长 4 字节 (Bytes)，二进制流，无包头包尾。
*   **协议定义**：

| 字节索引   | 数据类型 | 物理含义                       | 取值范围 & 逻辑说明                                          |
| :--------- | :------- | :----------------------------- | :----------------------------------------------------------- |
| **Byte 0** | `int8_t` | **动力电机**<br>(Motor)        | **0**: 停止<br>**[1, 100]**: 前进 (PWM 1%~100%)<br>**[-100, -1]**: 后退 (PWM 1%~100%) |
| **Byte 1** | `int8_t` | **舵机1 (水平)**<br>(Steering) | **0**: 居中 (90°)<br>**[1, 100]**: 左转幅度 (90°~180°)<br>**[-100, -1]**: 右转幅度 (90°~0°) |
| **Byte 2** | `int8_t` | **舵机2 (备用)**<br>(Reserved) | *逻辑同 Byte 1*<br>(若无第二路舵机，则作为保留位处理，暂时忽略) |
| **Byte 3** | `int8_t` | **校验位**<br>(Checksum)       | **XOR 校验**<br>`Byte[3] = Byte[0] ^ Byte[1] ^ Byte[2]`      |

*   **功能定义**：
    *   **校验机制**：收到数据包后首先计算 XOR，若校验失败则直接丢弃，防止干扰造成的误动作。
    *   **线性控制**：将 `int8` 的数值直接映射为 PWM 占空比，实现从慢到快的线性加速，而非之前的“一键全速”。
    *   **安全保护**：若超过 500ms 未收到有效数据包（如WiFi断开），强制停车复位。

### 2.3 红外循迹模式 (Tracking Mode) - **[P1 优先级]**
*   **触发条件**：通过 APP 指令或物理按键切换。
*   **功能定义**：
    *   读取 TCRT5000 传感器（3路）电平状态。
    *   算法逻辑：
        *   中间黑 -> 直行
        *   左边黑 -> 左转修正
        *   右边黑 -> 右转修正
    *   OLED 显示 "Mode: Tracking"。

### 2.4 智能避障模式 (Obstacle Avoid Mode) - **[P1 优先级]**
*   **触发条件**：通过 APP 指令或物理按键切换。
*   **功能定义**：
    *   HC-SR04 超声波持续测距。
    *   当距离 < 20cm 时，停车 -> 后退 -> 随机/指定方向转向。
    *   (进阶) 结合 SG90 舵机进行“摇头”扫描，寻找最优路径。
    *   OLED 实时刷新距离数值。

## 3. 开发阶段规划

*   **第一阶段（里程碑：动起来）**：
    *   完成 WiFi 连接与 TCP 数据收发。
    *   完成电机驱动整合。
    *   实现：手机发送 'F'，小车前进；发送 'S'，小车停止。
*   **第二阶段（里程碑：全功能）**：
    *   集成红外与超声波驱动。
    *   完善状态机逻辑，支持按键或指令切换四种模式。
    *   优化 OLED 界面交互。